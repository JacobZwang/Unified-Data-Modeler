<script lang="ts">
  import { io } from "socket.io-client";
  import type { Socket } from "socket.io-client";
  import { saveAs } from "file-saver";
  import * as yaml from "js-yaml";

  import { onMount } from "svelte";
  import Nav from "../components/Nav.svelte";
  import type { BaseParameter, Parameter } from "../models/parameter";
  import { flatSyntax } from "../logic/syntax_tree";

  let files: FileList;

  let parameters: Array<Parameter>;
  let modelName: string;
  let socket: Socket;
  let modelNameFromNetwork: boolean = false;

  let parametersFromNetwork: boolean = false;
  onMount(() => {
    console.log("MOUNTED");
    socket = io();

    socket.on("modelName", (newModelName) => {
      if (modelName != newModelName) {
        modelNameFromNetwork = true;
        modelName = newModelName;
      }
    });
    socket.on("parameters", (newParameters) => {
      console.log("PARAMETERS", parameters);
      if (parameters != newParameters) {
        parametersFromNetwork = true;
        parameters = [...newParameters];
      }
    });

    socket.on("disconnect", () => {
      socket.connect();
    });
  });

  let removeParameter = (index: number) => {
    parameters.splice(index, 1);
    parameters = parameters;
  };

  let addParameter = () => {
    parameters.push({
      name: "",
      type: flatSyntax[0],
      required: true,
    });
    parameters = parameters;
  };

  let exportModel = () => {
    console.log("logggg");
    var blob = new Blob(
      [
        "name: " + modelName + "\n" + "parameters:\n",
        parameters
          .map((value) => {
            return (
              "  - name: " +
              value.name +
              "\n    required: " +
              value.required +
              "\n    type: " +
              value.type.value
            );
          })
          .join("\n"),
      ],
      {
        type: "text/plain;charset=utf-8",
      }
    );

    saveAs(blob, "mymodel.udm.yaml");
  };

  $: {
    console.log("FILES", files);
    if (files != undefined && files != null && (files?.length ?? 0) != 0) {
      const reader = new FileReader();
      files
        .item(0)
        .text()
        .then((text) => {
          console.log("FILE TEXT", text);
          const doc = yaml.load(text);
          console.log(doc);
          modelName = doc.name;
          parameters = (doc.parameters as Array<BaseParameter>).map((base)=>{
            return  {
              name: flatSyntax.find((value)=>value.value ==base.type).name,
              type: flatSyntax.find((value)=>value.value ==base.type),
              required: base.required,
              
            } as Parameter
          })
        });
    }
  }

  $: parametersFromNetwork
    ? (parametersFromNetwork = false)
    : parameters != null
    ? socket?.emit("parameters", parameters)
    : null;
  $: modelNameFromNetwork
    ? (modelNameFromNetwork = false)
    : modelName != null
    ? socket?.emit("modelName", modelName)
    : null;
</script>

<svelte:head>
  <title>Unified Data Modeler</title>
</svelte:head>
<Nav />
<input placeholder="Model Name" bind:value={modelName} />
<table>
  <tr>
    <th> Name </th>
    <th> Required </th>
    <th> Type </th>
  </tr>
  {#if parameters != null}
    {#each parameters as paramater, index}
      <tr>
        <td><input bind:value={paramater.name} /></td>
        <td><input bind:checked={paramater.required} type="checkbox" /></td>
        <td
          ><select
            name="DataTypes"
            bind:value={parameters[index].type.value}
            bind:textContent={parameters[index].type.name}
            contenteditable
          >
            {#each flatSyntax as type}
              <option value={type.value}>{type.name}</option>
            {/each}
          </select></td
        >
      </tr>
    {/each}
  {/if}
</table>
<button on:click={addParameter}>Add Parameter</button>
<button on:click={exportModel}>Export</button>
<input type="file" bind:files accept=".yaml" />

<style>
  th {
    text-align: start;
    padding: 8px;
  }

  input {
    text-transform: lowercase;
  }
</style>
